name: æž„å»º macOS å‘å¸ƒåŒ…

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.6.0)'
        required: true
        default: '0.6.0'

env:
  APP_NAME: SmartRenamer
  PYTHON_VERSION: '3.10'

jobs:
  # macOS æž„å»º
  build-macos:
    name: æž„å»º macOS åº”ç”¨
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: ç”Ÿæˆåº”ç”¨å›¾æ ‡
        run: |
          python generate_icons.py
      
      - name: æž„å»ºåº”ç”¨åŒ…
        run: |
          pyinstaller --clean --noconfirm smartrenamer.spec
      
      - name: æµ‹è¯•åº”ç”¨
        run: |
          ./dist/SmartRenamer.app/Contents/MacOS/SmartRenamer --help
      
      - name: åˆ›å»º DMG
        run: |
          cd scripts/macos
          ./create_dmg.sh
      
      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd dist
          shasum -a 256 *.dmg > checksums-macos-${{ matrix.arch }}.txt
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-build
          path: |
            dist/*.dmg
            dist/*.app
            dist/checksums-macos-${{ matrix.arch }}.txt
          retention-days: 7

  # åˆ›å»ºå‘å¸ƒ
  create-release:
    name: åˆ›å»º GitHub Release
    needs: [build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.dmg" -o -name "*.app" -o -name "checksums*.txt" \) -exec cp {} release/ \;
          ls -lah release/
      
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          
          cat > release_notes.md << EOF
          # SmartRenamer v${VERSION}
          
          ## ðŸŽ‰ å‘å¸ƒè¯´æ˜Ž
          
          è¿™æ˜¯ SmartRenamer çš„ macOS å‘å¸ƒç‰ˆæœ¬ã€‚
          
          ### ðŸ“¦ ä¸‹è½½
          
          - **macOS (Intel)**: SmartRenamer-macOS-x86_64.dmg
          - **macOS (Apple Silicon)**: SmartRenamer-macOS-arm64.dmg
          
          æ”¯æŒ macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå…¼å®¹ Intel å’Œ Apple Silicon èŠ¯ç‰‡ã€‚
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          
          - æ™ºèƒ½åª’ä½“æ–‡ä»¶è¯†åˆ«å’Œé‡å‘½å
          - TMDB æ•°æ®åº“é›†æˆ
          - å¤šç§é‡å‘½åè§„åˆ™æ¨¡æ¿
          - æ‰¹é‡å¤„ç†æ”¯æŒ
          - åŽ†å²è®°å½•å’Œæ’¤é”€åŠŸèƒ½
          - çŽ°ä»£åŒ–å›¾å½¢ç•Œé¢
          
          ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - **macOS**: macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ”¯æŒ Intel (x86_64) å’Œ Apple Silicon (arm64) æž¶æž„
          
          ### ðŸ”’ æ–‡ä»¶æ ¡éªŒ
          
          æ‰€æœ‰æ–‡ä»¶çš„ SHA256 æ ¡éªŒå’ŒåŒ…å«åœ¨ checksums-macos-*.txt æ–‡ä»¶ä¸­ã€‚
          
          ### ðŸ“š æ–‡æ¡£
          
          - [å®‰è£…æŒ‡å—](https://github.com/smartrenamer/smartrenamer/blob/main/README.md)
          - [ä½¿ç”¨æ–‡æ¡£](https://github.com/smartrenamer/smartrenamer/blob/main/UI_GUIDE.md)
          - [æ‰“åŒ…æŒ‡å—](https://github.com/smartrenamer/smartrenamer/blob/main/PACKAGING_GUIDE.md)
          
          ### ðŸ› å·²çŸ¥é—®é¢˜
          
          å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/smartrenamer/smartrenamer/issues) ä¸­æŠ¥å‘Šã€‚
          
          EOF
          
          cat release_notes.md
      
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          name: SmartRenamer v${{ steps.release_notes.outputs.VERSION }}
          body_path: release_notes.md
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: å‘å¸ƒåˆ° PyPIï¼ˆå¯é€‰ï¼‰
        if: false  # éœ€è¦æ—¶è®¾ç½®ä¸º true
        run: |
          pip install build twine
          python -m build
          twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
