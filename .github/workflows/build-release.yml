name: æž„å»ºè·¨å¹³å°å‘å¸ƒåŒ…

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.6.0)'
        required: true
        default: '0.6.0'

env:
  APP_NAME: SmartRenamer
  PYTHON_VERSION: '3.10'

jobs:
  # Windows æž„å»º
  build-windows:
    name: æž„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pywin32
      
      - name: æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        run: |
          pyinstaller --clean --noconfirm smartrenamer.spec
      
      - name: æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          .\dist\SmartRenamer.exe --help
      
      - name: åˆ›å»ºä¾¿æºç‰ˆåŽ‹ç¼©åŒ…
        run: |
          cd dist
          Compress-Archive -Path SmartRenamer.exe, _internal -DestinationPath SmartRenamer-Windows-Portable.zip
      
      - name: å®‰è£… NSIS
        run: |
          choco install nsis -y
      
      - name: åˆ›å»ºå®‰è£…ç¨‹åº
        run: |
          & "C:\Program Files (x86)\NSIS\makensis.exe" scripts\windows\installer.nsi
        continue-on-error: true
      
      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd dist
          Get-FileHash -Algorithm SHA256 *.exe, *.zip | Format-List | Out-File -FilePath checksums-windows.txt
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: windows-build
          path: |
            dist/*.exe
            dist/*.zip
            dist/checksums-windows.txt
          retention-days: 7

  # macOS æž„å»º
  build-macos:
    name: æž„å»º macOS åº”ç”¨
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: æž„å»ºåº”ç”¨åŒ…
        run: |
          pyinstaller --clean --noconfirm smartrenamer.spec
      
      - name: æµ‹è¯•åº”ç”¨
        run: |
          ./dist/SmartRenamer.app/Contents/MacOS/SmartRenamer --help
      
      - name: åˆ›å»º DMG
        run: |
          cd scripts/macos
          ./create_dmg.sh
      
      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd dist
          shasum -a 256 *.dmg > checksums-macos-${{ matrix.arch }}.txt
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: macos-${{ matrix.arch }}-build
          path: |
            dist/*.dmg
            dist/*.app
            dist/checksums-macos-${{ matrix.arch }}.txt
          retention-days: 7

  # Linux æž„å»º
  build-linux:
    name: æž„å»º Linux AppImage
    runs-on: ubuntu-20.04
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xfixes0 \
            libxkbcommon-x11-0 \
            libgl1-mesa-glx \
            libegl1-mesa \
            libfontconfig1 \
            libdbus-1-3 \
            file \
            wget
      
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        run: |
          pyinstaller --clean --noconfirm smartrenamer.spec
      
      - name: æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          ./dist/SmartRenamer --help
        env:
          QT_QPA_PLATFORM: offscreen
      
      - name: ä¸‹è½½ appimagetool
        run: |
          wget -O /tmp/appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x /tmp/appimagetool
      
      - name: åˆ›å»º AppImage
        run: |
          cd scripts/linux
          ./create_appimage.sh
      
      - name: æµ‹è¯• AppImage
        run: |
          chmod +x dist/*.AppImage
          ./dist/*.AppImage --help
        env:
          QT_QPA_PLATFORM: offscreen
      
      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd dist
          sha256sum *.AppImage > checksums-linux.txt
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: linux-build
          path: |
            dist/*.AppImage
            dist/checksums-linux.txt
          retention-days: 7

  # åˆ›å»ºå‘å¸ƒ
  create-release:
    name: åˆ›å»º GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.exe" -o -name "*.zip" -o -name "*.dmg" -o -name "*.AppImage" -o -name "checksums*.txt" \) -exec cp {} release/ \;
          ls -lah release/
      
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          
          cat > release_notes.md << EOF
          # SmartRenamer v${VERSION}
          
          ## ðŸŽ‰ å‘å¸ƒè¯´æ˜Ž
          
          è¿™æ˜¯ SmartRenamer çš„è·¨å¹³å°å‘å¸ƒç‰ˆæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š
          
          ### ðŸ“¦ ä¸‹è½½
          
          - **Windows**: SmartRenamer-Windows-Setup.exe (å®‰è£…ç¨‹åº) æˆ– SmartRenamer-Windows-Portable.zip (ä¾¿æºç‰ˆ)
          - **macOS**: SmartRenamer-macOS.dmg (æ”¯æŒ Intel å’Œ Apple Silicon)
          - **Linux**: SmartRenamer-Linux-x86_64.AppImage
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          
          - æ™ºèƒ½åª’ä½“æ–‡ä»¶è¯†åˆ«å’Œé‡å‘½å
          - TMDB æ•°æ®åº“é›†æˆ
          - å¤šç§é‡å‘½åè§„åˆ™æ¨¡æ¿
          - æ‰¹é‡å¤„ç†æ”¯æŒ
          - åŽ†å²è®°å½•å’Œæ’¤é”€åŠŸèƒ½
          - çŽ°ä»£åŒ–å›¾å½¢ç•Œé¢
          
          ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **macOS**: macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **Linux**: ä¸»æµå‘è¡Œç‰ˆï¼ˆUbuntu 20.04+, Fedora 35+, Debian 11+ï¼‰
          
          ### ðŸ”’ æ–‡ä»¶æ ¡éªŒ
          
          æ‰€æœ‰æ–‡ä»¶çš„ SHA256 æ ¡éªŒå’ŒåŒ…å«åœ¨ checksums-*.txt æ–‡ä»¶ä¸­ã€‚
          
          ### ðŸ“š æ–‡æ¡£
          
          - [å®‰è£…æŒ‡å—](https://github.com/smartrenamer/smartrenamer/blob/main/README.md)
          - [ä½¿ç”¨æ–‡æ¡£](https://github.com/smartrenamer/smartrenamer/blob/main/UI_GUIDE.md)
          - [æ‰“åŒ…æŒ‡å—](https://github.com/smartrenamer/smartrenamer/blob/main/PACKAGING_GUIDE.md)
          
          ### ðŸ› å·²çŸ¥é—®é¢˜
          
          å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/smartrenamer/smartrenamer/issues) ä¸­æŠ¥å‘Šã€‚
          
          EOF
          
          cat release_notes.md
      
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          name: SmartRenamer v${{ steps.release_notes.outputs.VERSION }}
          body_path: release_notes.md
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: å‘å¸ƒåˆ° PyPIï¼ˆå¯é€‰ï¼‰
        if: false  # éœ€è¦æ—¶è®¾ç½®ä¸º true
        run: |
          pip install build twine
          python -m build
          twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
